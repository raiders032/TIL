# 1 Sharding

- 샤딩은 대규모 데이터베이스를 샤드라는 작은 단위로 분할하는 기술을 일컫는다
- 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관된 데이터 사이에는 중복이 없다



## 1.1 데이터베이스 확장

- 데이터베이스의 규모를 확장하는 데는 두 가지 접근법이 있다
  - Scale Up(수직적 확장)
  - Scale Out(수평적 확장)
- Scale Up의 단점으로 하나의 데이터베이스(수직적 확장)로 다룰 수 없을 만큼 많은 데이터를 저장하고 조회하려면 당연히 여러 데이터베이스를 이용하는 방식(수평적 확장)을 모색해야 할 것이다.
- Cassandra나 Dynamo처럼 분산 환경을 고려하여 만들어진 데이터베이스도 있지만, 범위 검색에 취약하거나 JOIN 연산을 사용할 수 없는 등 기능에 제약이 많다.
- 따라서 상대적으로 풍부한 기능을 사용하면서 데이터 확장을 꾀할 수 있는 방법은 RDBMS를 샤딩(sharding)하여 사용하는 것이 유리하다.



## 1.2 수평 분할

- 수평 분할(Horizontal Partitioning)이란 스키마(schema)가 같은 데이터를 두 개 이상의 테이블에 나누어 저장하는 디자인을 말한다. 
- 가령 같은 주민 데이터를 처리하기 위해 스키마가 같은 '서현동주민 테이블'과 '정자동주민 테이블'을 사용하는 것을 말한다. 
- 인덱스의 크기를 줄이고, 작업 동시성을 늘리기 위한 것이다. 
- 보통 수평 분할을 한다고 했을 때는 하나의 데이터베이스 안에서 이루어지는 경우를 지칭한다.



# 2 Sharding 방식



## 2.1 Modular sharding

> 
>
> <img src="https://woowabros.github.io/img/2020-07-06/thiiing-db-modular-sharding.png" alt="properties" style="zoom:50%;" />
>
> 모듈러샤딩은 PK를 모듈러 연산한 결과로 DB를 특정하는 방식입니다. 간략한 장단점은 아래와 같습니다.
>
> - 장점 : 레인지샤딩에 비해 데이터가 균일하게 분산됩니다.
> - 단점 : DB를 추가 증설하는 과정에서 이미 적재된 데이터의 재정렬이 필요합니다.
>
> 모듈러샤딩은 데이터량이 일정 수준에서 유지될 것으로 예상되는 데이터 성격을 가진 곳에 적용할 때 어울리는 방식입니다. 띠잉 서비스의 콘텐츠 관리 정책을 예로 들면, 서비스 오픈 시점에는 콘텐츠의 유지기간이 24시간으로 제한돼 있었습니다. 따라서 데이터가 항상 쌓이기만 하는 상황은 아니었고, 이런 경우 모듈러 샤딩을 적용하기에 알맞습니다. (여담으로 현재는 이 정책이 완화되어 무기한 보존이 가능합니다.) 물론 데이터가 꾸준히 늘어날 수 있는 경우라도 적재속도가 그리 빠르지 않다면 모듈러방식을 통해 분산처리하는 것도 고려해볼 법 합니다. 무엇보다 데이터가 균일하게 분산된다는 점은 트래픽을 안정적으로 소화하면서도 DB리소스를 최대한 활용할 수 있는 방법이기 때문입니다.



## 2.2 Range sharding

> <img src="https://woowabros.github.io/img/2020-07-06/thiiing-db-range-sharding.png" alt="properties" style="zoom:50%;" />
>
> 레인지샤딩은 PK의 범위를 기준으로 DB를 특정하는 방식입니다. 간략한 장단점은 아래와 같습니다.
>
> - 장점 : 모듈러샤딩에 비해 기본적으로 증설에 재정렬 비용이 들지 않습니다.
> - 단점 : 일부 DB에 데이터가 몰릴 수 있습니다.
>
> 레인지샤딩의 가장 큰 장점은 증설작업에 드는 비용이 크지 않다는 점입니다. 데이터가 급격히 증가할 여지가 있다면 레인지방식도 좋은 선택일겁니다. 다만 단점을 무시할 수 없는데요. 주로 활성유저가 몰린 DB로 트래픽이나 데이터량이 몰릴 수 있기 때문입니다. 기껏 분산처리를 했는데 이런 상황이 발생하면 또다시 부하분산을 위해 해당 DB를 쪼개 재정렬하는 작업이 필요하고, 반대로 트래픽이 저조한 DB는 통합작업을 통해 유지비용을 아끼도록 관리해야 합니다.





# 3 Sharding의 문제점

- 샤딩은 데이터베이스 규모 확장을 실현하는 훌륭한 기술이지만 완벽하지는 않다
- 샤딩을 도입하면 시스템이 복잡해지고 풀어야할 새로운 문제가 생긴다



## 3.1 Resharding

- Resharding이 필요한 경우는 아래와 같다
- 데이터가 너무 많아져 추가적인 샤드가 필요할 때
- 특정 샤드의 공간 소모가 다른 샤드에 비해 빨리 진행되는 `샤드 소진`이 발생할 때
- 이러한 현상이 발생하면 샤드 키를 계산하는 함수를 변경하고 데이터를 재배치해야 한다



## 3.2 Celebrity

- 유명인사 문제 또는 핫스팟 키라고 불리는 문제
- 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제다
- 가령 BTS, 저스틴 비버와 같은 유명인사가 전부 같은 샤드에 저장되어 있을 때 해당 샤드에만 과부하가 걸리게 될 것



## 3.3 조인과 비정규화

- 일단 하나의 데이터베이스를 여러 샤드로 쪼개면 여러 샤드에 걸친 데이터를 조인하기 힘들어진다



참조

* https://d2.naver.com/helloworld/14822
* https://woowabros.github.io/experience/2020/07/06/db-sharding.html
* [가상 면접 사례로 배우는 대규모 시스템 설계 기초](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9788966263158#:~:text=%E3%80%8A%EA%B0%80%EC%83%81%20%EB%A9%B4%EC%A0%91%EC%9C%BC%EB%A1%9C%20%EB%B0%B0%EC%9A%B0%EB%8A%94%20%EB%8C%80%EA%B7%9C%EB%AA%A8,%EB%A5%BC%20%ED%92%80%20%EC%88%98%20%EC%9E%88%EB%8F%84%EB%A1%9D%20%EB%8F%95%EB%8A%94%EB%8B%A4.)