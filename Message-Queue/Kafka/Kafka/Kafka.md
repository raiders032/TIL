# 1 Kafka

* Kafka는 이벤트 스트리밍 플랫폼이다.

<br>

## 1.1 Kafka가 제공하는 기능

- 카프카는 이벤트 스트리밍을 위해 아래와 같은 기능을 제공한다.
	1. 다른 시스템에서 데이터를 지속적으로 가져오가나 내보내는 것을 포함하여, 이벤트 스트림에 쓰기와 읽기를 제공한다.
	2. 원하는 기간 동안 이벤트 스트림을 안정적이고 신뢰할 수 있게 저장한다.  
	3. 이벤트 스트림이 발생하는 즉시 또는 소급적으로 처리한다.
- 위 모든 기능이 분산적이고, 고도로 확장 가능하며, 탄력적이고, 장애에 강하며, 안전한 방식으로 제공된다.

<br>

# 2 주요 특징

## 2.1 높은 처리량과 낮은 지연시간

- 카프카를 사용하는 가장 큰 이유가 높은 처리량과 낮은 지연시간이다

![Throughput (MB/s) | End-to-End Latency Quantiles](throughput-and-latency-quantiles.png)

| Kafka                  | Pulsar               | **RabbitMQ** (Mirrored) |                              |
| ---------------------- | -------------------- | ----------------------- | ---------------------------- |
| Peak Throughput (MB/s) | 605 MB/s             | 305 MB/s                | 38 MB/s                      |
| p99 Latency (ms)       | 5 ms (200 MB/s load) | 25 ms (200 MB/s load)   | 1 ms* (reduced 30 MB/s load) |

- 컨플루언트가 진행한 메시징 시스템 간의 성능 비교 표
- 가장 높은 처리량을 보여준는 건 카프카다
- 가장 빠른 응답 속도를 보여주는 것은 RabbitMQ지만 처리량과 응답 속도를 같이 비교하면 카프카가 단연 독보적인 성능을 보여준다.

<br>

**페이지 캐시**

- 카프카가 높은 처리량을 얻기 위한 사용한 기능
- 페이지 캐시는 디스크에 읽고 쓰는 대신 물리 메모리 중 애플리케이션이 사용하지 않는 일부 잔여 메모리를 활용한다.
- 카프카가 직접 디스크에서 읽고 쓰기를 하지 않고 페이지 캐시를 통해 읽기 쓰기를 하므로 디스크 I/O 접근을 줄여 성능을 높인다.

<br>

**배치 전송 처리**

- 카프카는 프로듀서, 컨슈머 클라이언트들과 서로 통신하며 수많은 메시지를 주고받는다.
- 이때 통신을 묶어서 처리하면 단건으로 통신할 때에 비해 네트워크 오버헤드를 줄일 수 있다

<br>

**압축 전송**

- 카프카는 메시지 전송 시 성능이 높은 압축 전송을 사용하는 것을 권장한다.
- gzip, snappy, lz4, zesty 압축 타입을 지원한다.
	- 높은 압축률을 원한다면 gzip, zstd를 권장한다.
	- 빠른 응답 속도를 원한다면 lz4, snappy를 권장한다.
- 앞서 설명한 배치 전송 처리와 결합해 사용하면 더욱 성능을 높일 수 있다.

<br>

## 2.2 높은 확장성

- 분산 시스템은 네트워크상에서 연결된 컴퓨터들의 그룹을 말하며 단일 시스템이 갖지 못한 높은 성능을 목표로 한다.
- 카프카는 분산 시스템으로 최초 구성한 클러스터의 리소스가 한계치의 도달하면 브로커를 추가하는 방식으로 확장이 가능하다.
- 카프카에서 브로커는 온라인 상태에서 매우 간단하게 추가할 수 있다.

<br>

## 2.3 고가용성

- 서버 또는 노드에 장애가 발생할 때 다른 서버 또는 노드가 처리하므로 장애 대응이 탁월하다.
- 카프카는 2013년 클러스터 내 **리플리케이션** 기능을 추가해 카프카 클러스터의 고가용성을 확보했다.
- 리플리케이션이란 토픽의 파티션을 복제하는 것이다.
	- 데이터가 복제되기 때문에 한 서버가 다운되더라도 다른 서버에 데이터가 복제되어 있기 대문에 다운된 서버의 역할을 다른 서버가 대체할 수 있다.

<br>

## 2.4 내구성

- 프로듀서가 카프카로 메시지를 전달할 때 프로듀서의 acks라는 옵션을 조정하여 메시지의 내구성을 강화할 수 있다.
- 강력한 메시지의 내구성을 원하면 acks=all로 사용하면 된다.
- 프로듀서가 전송한 메시지는 카프카의 로컬 디스크에 안전하게 저장된다.
- 전통적인 메시징 시스템의 경우 컨슈머가 메시지를 가져감과 동시에 저장소에서 메시지를 삭제하지만 카프카에서는 삭제되지 않고 지정된 설정 시간 또는 로그의 크기만큼 로컬 디스크에 보관하여 장애가 발생해도 복구가 가능하다

<br>

## 2.5 개발 편의성

- 카프카는 메시지를 전송하는 역할을 하는 프로듀서와 메시지를 가져오는 역할을 하는 컨슈머가 완벽하게 분리되어 서로 영향을 주지 않는다.

<br>

# 3 카프카 구성 요소

- `ZooKeeper`
	- 카프카의 메타데이터 관리 및 브로커의 정상상태 점검을 담당한다.
	- [[Zookeeper]] 참고
- `Kafka`(Kafka Cluster): 여러 대의 브로커로 구성된 클러스터를 의미한다.
- `broker`: 
	- 카프카 애플리케이션이 설치 된 서버 또는 노드를 말한다.
	- [[Broker]] 참고
- `producer`: 
	- 카프카로 메시지를 보내는 역할을 하는 클라이언트를 말한다.
	-  [[Producer]] 참고
- `consumer`: 
	- 카프카에서 메시지를 꺼내가는 역할을 하는 클라이언트를 말한다.
	- [[Consumer]] 참고
- `topic`
	- 카프카는 메시지를 토픽으로 구분한다. 각 토픽의 이름은 카프카 내에서 고유하다.
- `partition` 
	- 병렬 처리 및 고성능을 얻기 위해 하나의 토픽을 여러 개로 나눈 것을 의미한다.
- `segment` 
	- 프로듀서가 전송한 실제 메시지가 브로커의 로컬 디스크에 저장되는 파일을 말한다.
- `message`(또는 record)
	- 프로듀서가 브로커로 전송하거나 컨슈머가 읽어가는 데이터 조각을 말한다.

<br>

참고

- [실전 카프카 개발부터 운영까지](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9791189909345)
