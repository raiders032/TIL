# 1 쿼리

- 여러 서비스, 여러 DB에 분산된 데이터를 조회해야 한다.
- 마이크로서비스 아키텍처에서는 다음 두 가지 패턴으로 쿼리를 구현한다.
	- API 조합: 서비스 클라이언트가 데이터를 가진 여러 서비스를 직접 호출하여 그 결과를 조합하는 패턴이다. 가급적 이 방법을 쓰는 것이 좋다.
	- CQRS 패턴: 쿼리만 지원하는 하느 이상의 뷰 전용 DB를 유지하는 패턴이다. API 조합보다 강력한 만큼 구현하기 더 복잡하다.


# 2 API 조합 패턴

- API 조합 패턴에는 두 가지 구성요소가 있다.
	- API 조합기: 프로바이더 서비스를 쿼리하여 데이터를 조합한다.
	- 프로바이더 서비스: 최종 결과로 반환할 데이터의 일부를 갖고 있는 서비스

## 2.1 단점

- 오버헤드 증가 
	- 모노리식 애플리케이션은 요청 한 번으로 대부분 쿼리 하나로 필요한 데이터를 조회한다.
	- API 조합 패턴은 여러 번 요청하고 여러 DB 쿼리를 실행한다.
- 가용성 저하
	- 가용성은 더 많은 서비스가 개입할수록 감소한다.
	- 하나의 쿼리에 API 조합기, 둘 이상의 프로바이더가 반드시 개입되는 구조라 가용성이 낮아진다.
	- 가용성을 높이기 위해 프로바이더 서비스가 불능인 경우 캐시 데이터를 이용하는 것과 API 조합기가 미완성 데이터를 반환하는 것
- 데이터 일관성 결여
	- 모노리식 애플리케이션은 대부분 한 트랜잭션으로 쿼리를 실행한다.
	- ACID 트랜잭션은 여러 DB 쿼리를 실행해도 데이터를 일관되게 바라볼 수 있다.
	-  API 조합 패턴은 여러 DB를 대상으로 쿼리를 실행하기 때문에 일관되지 않은 데이터가 반활될 수 있다.


<br>

## 2.2 API 조합기

- API 조합기는 웹 애플리케이션 처럼 웹 페이지를 렌더링 하는 클라이언트일 수 있고 쿼리 작업을 API 끝점으로 표출한 API 게이트웨이나 프런트엔드를 위한 백엔드 패턴의 변형일 수 있다.
- 다음은 어느 컴포넌트를  API 조합기로 선정해야 될까? 하나씩 알아보자. 


### 2.2.1 클라이언트 조합기

- 클라이언트가 동일한 LAN에서 실행중이라면 가장 효율적으로 조회할 수 있다.
- 하지만 클라이언트가 방화벽 외부에 있고 서비스가 네트워크가 느리다면 그리 실용적이지 않다.
![[Pasted image 20230817192325.png]]


### 2.2.2 API 게이트웨이

- 모바일 기기 등 방화벽 외부에서 접근하는 클라이언트가 API 호출 한번으로 여러 서비스의 데이터를 조회할 수 있어 효율적이다.
![[Pasted image 20230817192317.png]]

## 2.3 API 조합기 리액티브 프로그래밍

- 쿼리 작업의 반응 시간을 줄이려면 가능한 API 조합기가 프로바이더 서비스를 병렬 호출해야 한다.
- 가령 주문 검색 애그리거트는 호출 대상인 네 서비스가 서로 의존 관계가 없어 동시 호출 할 수 있다.
	- 하지만 어떤 프로바이더 서비스를 호출하기 위해 다른 프로바이더 서비스의 결과를 먼저 가져와야 하는 경우가 있다.
		- 이 경우 프로바이더 서비스를 순차 호출해야 한다.



# 3 CQRS 패턴

- 관심사의 분리/구분에 관한 패턴이다.
- 조회 기능은 쿼리 쪽 모듈 및 데이터 모델에 생성/수정/삭제 기능은 커맨드 쪽 모듈 및 데이터 모델에 구현하는 것이다.
- 양쪽 데이터 모델 사이의 동기화는 커맨드 쪽에서 발행한 이벤트를 쿼리 쪽에서 구독하는 방식으로 이루어진다.
- 비CQRS에서는 단일 DB가 전체 CRUD를 처리하고 CQRS에서는 CUD용 DBD와 쿼리용 DB를 따로 둔다. 커맨드 쪽 DB가 변경될 때마다 발행되는 이벤트를 구독하여 항상 최신 상태를 유지한다.
- 쿼리 쪽 서비스는 여러 서비스가 발행한 이벤트를 구독해서 구축된 뷰를 규현하기 좋은 방법이다.
	- 이런 뷰는 특정 서비스에 종속되지 않기 때문에 스탠드얼론 서비스로 구현하는 것이 타당하다.


## 3.1 장점

- 마이크로서비스 아키텍처에서 쿼리를 효율적으로 구현할 수 있다.
	- API 조합 패턴에서는 거대한 데이터 뭉치를 인-메모리 조인하는 값비싼 작업을 해야한다.
	- 여러 서비스에서 데이터를 미리 조인해 놓는 CQRS 뷰를 이용하는 것이 간편하고 훨씬 효율적이다.
- 다양한 쿼리를 효율적으로 구현할 수 있다.
	- CQRS 패턴을 이용하면 각 쿼리가 효율적으로 구현된 하나 이상의 뷰를 정의하여 단일 데이터 저장소의 한계를 극복할 수 있다.
- 관심사가 더 분리된다.
	- 도메인 모델과 그에 대응되는 영속화 데이터 모델이 커맨드, 쿼리를 모두 처리하지 않는다.
	- CQRS 패턴은 커맨드, 쿼리 쪽에 각각 알맞는 코드 모듈과 DB 스키마를 별도로 정의한다.


## 3.2 단점

- 아키텍처가 복잡해진다.
- 복제 시차를 극복해야 한다.
	- 커맨드 쪽이 이벤트를 발행하는 시점과 쿼리 쪽이 이벤트를 받아 뷰를 업데이트 하는 시점 사이에 지연이 발생한다.