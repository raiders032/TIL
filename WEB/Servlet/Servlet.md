# 서블릿(Servlet)

>  자바를 사용하여 웹페이지를 동적으로 생성하는 서버측 프로그램 혹은 그 사양을 말하며, 흔히 "서블릿"이라 불린다. 자바 서블릿은 웹 서버의 성능을 향상하기 위해 사용되는 자바 클래스의 일종이다. 서블릿은 JSP와 비슷한 점이 있지만, JSP가 HTML 문서 안에 Java 코드를 포함하고 있는 반면, 서블릿은 자바 코드 안에 HTML을 포함하고 있다는 차이점이 있다.



# 1. Servlet의 특징

```java
@WebServlet(name = "helloServlet", urlPatterns = "/hello")
public class HelloServlet extends HttpServlet {
 @Override
 protected void service(HttpServletRequest request, HttpServletResponse response){
 //애플리케이션 로직
 }
}
```

* urlPatterns(/hello)의 URL이 호출되면 서블릿 코드가 실행
* HTTP 요청 정보를 편리하게 사용할 수 있는 HttpServletRequest
* HTTP 응답 정보를 편리하게 제공할 수 있는 HttpServletResponse
* 개발자는 HTTP 스펙을 매우 편리하게 사용



# 2. 서블릿의 흐름

**HTTP 요청시**

1. WAS는 Request, Response 객체를 새로 만들어서 서블릿 객체 호출
2. 개발자는 Request 객체에서 HTTP 요청 정보를 편리하게 꺼내서 사용
3. 개발자는 Response 객체에 HTTP 응답 정보를 편리하게 입력
4. WAS는 Response 객체에 담겨있는 내용으로 HTTP 응답 정보를 생성



# 3. Servlet 컨테이너

* 톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 함
* 서블릿 컨테이너는 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기 관리
* 서블릿 객체는 **싱글톤**으로 관리
  * 고객의 요청이 올 때 마다 계속 객체를 생성하는 것은 비효율
  * 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용
  * 모든 고객 요청은 동일한 서블릿 객체 인스턴스에 접근
  * 공유 변수 사용 주의
  * 서블릿 컨테이너 종료시 함께 종료
* JSP도 서블릿으로 변환 되어서 사용
* 동시 요청을 위한 멀티 쓰레드 처리 지원



## 3.1 쓰레드 풀

* 쓰레드가 Servlet을 실행하는 주체이다
* 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
  * 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 
  * 톰캣은 최대 200개 기본 설정 (변경 가능) 
* 사용 • 쓰레드가 필요하면, 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.
* 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다. 
* 최대 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없으면? • 
  * 기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정할 수 있다.

**쓰레드 풀의 장점**  

* 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고, 응답 시간이 빠르다.
* 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.



## 3.2 실무 팁

* WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread) 수이다.
* 이 값을 너무 낮게 설정하면?
  * 동시 요청이 많으면, 서버 리소스는 여유롭지만, 클라이언트는 응답 지연
* 이 값을 너무 높게 설정하면?
  * 동시 요청이 많으면, CPU, 메모리 리소스 임계점 초과로 서버 다운
* 장애 발생시?
  * 클라우드면 일단 서버부터 늘리고, 이후에 튜닝
  * 클라우드가 아니면 열심히 튜닝

**쓰레드 풀의 적정 숫자**

* 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다름
* 성능 테스트
  * 최대한 실제 서비스와 유사하게 성능 테스트 시도
  * 툴: 아파치 ab, 제이미터, nGrinder



참고

* https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1/dashboard