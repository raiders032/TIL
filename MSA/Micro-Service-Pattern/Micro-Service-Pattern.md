
마이크로서비스 아키텍처의 핵심 제약 조건은 서비스를 느슨하게 결합한다는 것이다. 

## 서비스

- 마이크로서비스에서 서비스란 무엇인가?
- 서비스는 어떤 기능이 구현되어 단독 배포가 가능한 소프트웨어 컴포넌트이다.
- 서비스 API는 내구 구현 상세를 캡슐화한다.
	- API를 우회하여 서비스에 접근하는 코드를 작성할 수 없으므로 애플리케이션 모듈성이 보장된다.
- 각각의 마이크로서비스는 자체 아키텍처를 갖고 있기 때문에 기술 스택을 독자적으로 구축할 수 있다.

<br>

## 느슨한 결합

- 느슨하게 결합된 서비스는 마이크로서비스의 특징이다.
- 서비스는 구현 코드를 감싼 API를 통해 상호 작용하므로 클라이언트에 영향을 미치지지 않고 내부 구현을 변경할 수 있다.
- 서비스가 DB 테이블을 서로 공유하지 않기 때문에 런타임 격리가 향상된다.
	- 어떤 서비스가 DB락을 획득하여 다른 서비스를 블로킹하는 일 자체가 불가능하다.
	- 그러나 여러 서비스에 걸쳐 데이터를 쿼리하고 일관성을 유지하는 일은 더 복잡해 진다.

<br>

## 공유 라이브러리

- 코드 중복을 방지하기 위해 여러 애플리케이션에서 재사용 가능한 기능을 라이브러리(모듈)로 패키징하는 것은 당연한 일이다.
- 마이크로서비스에서도 공유 라이브러리를 사용하고 싶은 유혹에 빠지기 쉽다. 서비스 코드 중복을 줄일 수 있지만 의도치 않은 서비스 간 결합도를 유발하지 않도록 주의해야 한다.

<br>

## 서비스의 규모

- 마이크로라는 어감 때문에 서비스를 아주 작게 만들어야 할 것 같다.
- 서비스의 크기가 중요한게 아니라 작은 팀이 짫은 시간에 다른 팀과 협동하는 부분은 최소로 하여 가능한 서비스의 규모를 산정해야 한다.

<br>

## 서비스 분해의 장애물

- 네트워크 지연
	- 서비스를 여러 개로 나누면 서비스 간 왕복 횟수가 급증한다.
- 동기 IPC로 인한 가용성 저하
	- 주문 서비스의 경우 타 서비스와의 통신이 필요하다. REST API를 호출하는 것이 가장 쉬운 통신방법이지만 타 서비스 중 하나라도 불능일 경우 주문이 생성되지 않는다.
	- 이런 경우 비동기 메시지으로 강합 결합도를 제거하고 가용성을 높일 수 있다.
- 데이터 일관성 유지
	- 주문 서비스의 경우 주방 서비스의 티켓 상태를 변경하고 배달 서비스에 배달 스케줄을 잡아야 하므로 두 서비스 모두 업데이트 된다. 이런 경우 두 업데이트가 원자적으로 일어나야 한다.
	- 이런 경우 SAGA를 이용해 데이터 일관성을 유지한다.
	- 기존 ACID 트랜잭션보다 복잡하지만 다양한 상황에서도 잘 동작한다.
	- 한 가지 단점은 eventual consistency를 보장하는 것이다.
	- 어떤 데이터를 원자적으로 업데이트 하려면 그 데이터를 하나의 서비스 내부에 두어야 하는데 이는 분해의 걸림돌이 된다.


# IPC

- HTTP 기반 REST
- gRPC
- AMQP
- STOMP


## 상호 작용 스타일

**일대일/일대다**

- 일대일: 각 클라이언트 요청은 정확히 한 서비스가 처리한다.
- 일대다: 각 클라이언트 요청을 여러 서비스가 협동하여 처리한다.


**동기/비동기**

- 동기: 클라이언트 서비스가 제시간에 응답하리라 기대하고 대기 도중 블로킹할 수 있다.
- 비동기: 클라이언트가 블로킹되지 않는다. 응답은 즉시 전송되지 않아도 된다.


## REST

- 장점
	- 단숙하고 익숙하다
	- 포스트맨, curl 같은 도구로 간편하게 테스트 가능하다.
	- 요청/응답 스타일의 통신을 직접 지원한다.
	- HTTP는 방화벽 친화적이다.
	- 중간 브로커가 없어 시스템 아키텍처가 단순하다.
- 단점
	- 요청/응답 스타일 통신만 지원
	- 가용성이 떨어진다. 클라이언트 서비스가 직접 통신하기에 양쪽 다 실행중이어야 한다.
	- 서비스 인스턴스들의 위치를 클라이언트가 알고 있어야 한다.
		- 서비스 디스커버리 메커니즘을 통해 찾을 수 있으므로 큰 단점은 아니다.
	- 요청 한 번으로 여러 리소스를 가져오기 어렵다.
	- 다중 업데이트 작업을 HTTP 동사에 매핑하기 어렵다.

<br>

## gRPC

- 장점
	- 다양한 업데이트 작업이 포함된 API를 설계하기 쉽습니다.
	-  특히 큰 메시지를 교환할 때 콤팩트하고 효율적인 IPC입니다.
	- 양방향 스트리밍 덕분에 RPI, 메시징 두 가지 통신 방식 모두 가능합니다.
	- 다양한 언어로 작성된 클라이언트/서버 간 연동이 가능합니다.

- 단점.
	- 자바스크립트 클라이언트가 하는 일이 REST/JSON 기반 API보다 더 많습니다.
	- 구형 방화벽은 HTTP/2를 지원하지 않습니다.