# 1 SQS

- AWS에서 제공하는 Simple Queue Service(SQS)는 완전 관리형 메시지 대기열 서비스로, 대규모 분산 애플리케이션에서 컴포넌트 간의 메시지를 안정적으로 전송하고 받을 수 있게 합니다. 
- SQS는 거의 무제한의 메시지 처리량과 규모 조정 가능성을 제공하여, 애플리케이션의 다양한 요구 사항을 충족시킵니다.

<br>

# 2 장점

## 2.1 보안

- Amazon SQS 대기열에 메시지를 보낼 수 있는 사람과 받을 수 있는 사람을 제어할 수 있습니다.
- 기본 Amazon SQS 관리 서버 측 암호화(SSE) 또는 AWS Key Management Service(AWS KMS)에서 관리하는 사용자 정의 SSE 키를 사용하여 큐의 메시지 내용을 보호할 수 있습니다.

<br>

## 2.2 내구성

- 메시지의 안전을 위해 Amazon SQS는 메시지를 여러 서버에 저장합니다. 
- 표준 큐는 적어도 한 번의 메시지 전달을 지원하며, FIFO 큐는 정확히 한 번의 메시지 처리를 지원합니다.

<br>

## 2.3 가용성

- Amazon SQS는 중복 인프라를 사용하여 메시지에 대한 고도로 동시 접근 및 메시지 생산 및 소비의 고가용성을 제공합니다.

<br>

## 2.4 확장성

- Amazon SQS는 각 버퍼링된 요청을 독립적으로 처리하여 로드 증가나 스파이크를 처리하기 위해 확장할 수 있습니다.

## 2.5 신뢰성

- Amazon SQS는 메시지를 처리하는 동안 잠가 두어 다중 생산자가 메시지를 보내고 다중 소비자가 메시지를 동시에 받을 수 있도록 합니다.

<br>
## 2.6 사용자 정의

- 큐는 꼭 같을 필요가 없습니다. 
- 예를 들어, 큐에 기본 지연을 설정할 수 있습니다. 
- 256KB 이상의 메시지 콘텐츠를 Amazon Simple Storage Service(Amazon S3) 또는 Amazon DynamoDB를 사용하여 저장하고, Amazon SQS는 Amazon S3 객체에 대한 포인터를 보관할 수 있습니다. 또는 큰 메시지를 더 작은 메시지로 분할할 수 있습니다.

<br>

# 3 유형

- SQS는 두 가지 주요 큐 유형을 제공합니다
	- Standard Queues
	- FIFO Queues
- Standard Queues는 애플리케이션이 한 번 이상 도착하고 순서대로 처리되지 않는 메시지를 처리할 수 있는 경우 사용할 수 있습니다.
- FIFO Queues는 작업 및 이벤트의 순서가 중요하거나 중복을 허용할 수 없는 애플리케이션 간의 메시징 전송을 위해 사용할 수 있습니다.

<br>

## 3.1 Standard Queues

- **무제한 처리량**: 표준 큐는 API 호출당 거의 무제한의 트랜잭션을 지원합니다.
- **적어도 한 번의 전달 보장**: 각 메시지는 최소 한 번 전달됩니다. 그러나 네트워크 지연이나 다른 요인으로 인해 가끔 메시지가 중복으로 전달될 수 있습니다.
- **Best-Effort Ordering**: 메시지는 대부분 전송된 순서대로 전달되지만, 완벽한 순서는 보장되지 않습니다.

<br>

## 3.2 FIFO Queues

- **높은 처리량**: FIFO 큐는 초당 최대 3,000개의 메시지 처리를 지원합니다(배치 사용 시). 높은 처리량 모드를 활성화하면 이 수치가 증가합니다.
	- 배치를 사용하지 않을 경우 초당 최대 300개의 메시지(초당 300번의 전송, 수신 또는 삭제 작업)를 지원합니다.
- **단 한 번의 처리 보장**: 각 메시지는 정확히 한 번만 전달됩니다, 중복 없이.
- **엄격한 선입선출 순서**: 메시지는 엄격한 순서대로 전달되어, 전송된 순서를 정확하게 유지합니다.

<br>

# 4 SNS와 SQS의 차이점

- AWS에서 제공하는 Amazon SQS, Amazon SNS, 및 Amazon MQ는 모두 고도로 확장 가능하며 사용하기 쉬운 관리형 메시징 서비스입니다.
- 하지만 이들 서비스는 각각의 특정 시나리오와 요구 사항에 맞춰 설계되었습니다.

<br>

**SQS**

- Amazon Simple Queue Service(SQS)는 완전 관리형 메시지 대기열 서비스로, 대규모 분산 애플리케이션의 컴포넌트 간에 메시지를 안정적으로 전송하고 받습니다.
- SQS는 개발자가 메시지 처리량을 거의 무제한으로 확장할 수 있게 해주며, 애플리케이션의 다양한 요구 사항을 충족시킵니다.
- 메시지는 일반적으로 단일 구독자에 의해 처리되며, SQS와 SNS는 종종 함께 사용되어 팬아웃 메시징 어플리케이션을 만듭니다.

<br>

**SNS**

- Amazon Simple Notification Service(SNS)는 게시-구독 모델을 기반으로 하는 서비스로, 발행자(생산자)로부터 여러 구독자 엔드포인트(소비자)에게 메시지 전달을 제공합니다.
- SNS는 메시지를 주제(topic)에 게시하며, 구독자는 이 주제를 구독하고 다양한 엔드포인트(예: Amazon SQS, Lambda, HTTP, 이메일, 모바일 푸시 알림)를 통해 메시지를 받습니다.
- SNS는 실시간 메시지 라우팅을 제공하며, 구독자가 메시지 발행 시간에 사용할 수 없는 경우 메시지를 나중에 검색할 수 없습니다.

<br>

**요약**

| SNS (Simple Notification Service) | SQS (Simple Queue Service) |
| --------------------------------- | -------------------------- |
| 퍼블리시/구독 모델 (Pub/Sub)              | 큐 기반 메시징 서비스               |
| 푸시 메커니즘                           | 폴 메커니즘                     |
| 메시지를 토픽에 게시하면 여러 구독자에게 전달됨        | 일반적으로 메시지는 단일 컨슈머에 의해 처리됨  |

<br>

# 5 Short and Long Polling

- SQS는 메시지를 효율적으로 검색하기 위해 short polling과 long polling 두 가지 방법을 제공합니다.

<br>

**Short Polling**
- 기본 설정으로, 큐가 비어 있는 경우 즉시 응답을 반환합니다.

<br>

**Long Polling**
- 더 효율적인 메시지 처리를 위해, 큐가 비어 있더라도 서버는 메시지가 도착할 때까지 응답을 지연시킵니다. 
- 이는 불필요한 API 호출 수를 줄이고, 메시지가 도착하는 즉시 처리할 수 있도록 합니다.
- Long polling은 비용을 절감하고 메시지 처리의 효율성을 높이는 방법으로 권장됩니다.

<br>

# 6 메시지 수명 주기

## 6.1 수명 주기

- Amazon SQS 메시지의 수명 주기는 생성부터 삭제까지 다음과 같은 단계를 거칩니다.

1. **메시지 생성 및 전송**
    - 생산자가 메시지 A를 대기열로 보냅니다. 
    - 이 메시지는 Amazon SQS 서버에 중복으로 분산되어 저장됩니다.
2. **메시지 수신 및 처리**
    - 소비자가 메시지를 처리할 준비가 되면 대기열에서 메시지를 수신합니다. 
    - 이때 메시지 A가 반환됩니다. 
    - 메시지 A가 처리되는 동안에는 대기열에 남아 있지만, **가시성 타임아웃(visibility timeout)** 기간 동안 후속 수신 요청에는 반환되지 않습니다.
3. **메시지 삭제**
    - 소비자가 메시지 A를 처리 완료 후 대기열에서 삭제합니다.
    - 이렇게 하면 가시성 타임아웃이 만료된 후에 메시지가 다시 수신 및 처리되지 않도록 합니다.
4. **자동 삭제**
    - Amazon SQS는 최대 메시지 보존 기간을 초과한 메시지를 자동으로 삭제합니다.
    - 기본 메시지 보존 기간은 4일이며, SetQueueAttributes 작업을 사용하여 60초에서 1,209,600초(14일)까지 설정할 수 있습니다.

<br>

## 6.2 가시성 타임아웃(Visibility Timeout)

- 가시성 타임아웃은 소비자가 대기열에서 메시지를 수신한 후 일정 기간 동안 다른 소비자가 동일한 메시지를 수신하지 못하도록 하는 시간입니다.
- 이 기간 동안 메시지는 "보이지 않는 상태"로 유지되며, 소비자가 해당 메시지를 처리할 수 있는 시간을 제공합니다.
- 가시성 타임아웃이 설정되면, 메시지를 수신한 소비자는 타임아웃이 끝나기 전에 메시지를 처리하고 삭제해야 합니다.
- 만약 타임아웃이 만료될 때까지 메시지가 삭제되지 않으면, 해당 메시지는 다시 대기열에서 보이게 되어 다른 소비자가 수신할 수 있게 됩니다.
- 기본 가시성 타임아웃은 30초이며, 애플리케이션 요구 사항에 맞게 조정할 수 있습니다.